# Quick reference chart for job hierarchy:
#                         gerrit-setup      (this repo)
#                             |
#                         gerrit-base       (gerrit repo)
#                             |
#         +-------------------+-----------------+
#         |                                     |
# gerrit-build-base (this repo)      gerrit-plugin-build (this repo)
#         |
# gerrit-build      (gerrit repo)

- job:
    name: gerrit-setup
    description: |
      Base job for building Gerrit

      This job sets up any supplied repos which are required for any
      kind of gerrit-related build (plugins or Gerrit itself).

      However, it does not include all of the required repos; for
      that, see :zuul:job:`gerrit-base` which inherits from this and
      adds branch-appropriate required-projects.
    pre-run: playbooks/gerrit-setup/pre.yaml
    post-run: playbooks/gerrit-setup/post.yaml
    required-projects:
      - gerrit
    vars:
      bazel_cache_container: bazel-cache-67e7ca4394f4
      bazelisk_cache: "--remote_cache=http://localhost/{{ bazel_cache_container }}"
      zuul_copy_output:
        /var/log/nginx/access.log: logs
        /var/log/nginx/error.log: logs
        /etc/nginx/sites-enabled/bazel-cache: logs

- job:
    name: gerrit-build-base
    parent: gerrit-base
    description: |
      Build Gerrit

      This job sets up submodule repos in a Gerrit tree and runs
      bazelisk.  However, it does not include all of the required
      repos; for that, see :zuul:job:`gerrit-build` which inherits
      from this and adds required-projects.

      Responds to these variables:

      .. zuul:jobvar:: baselisk_targets

         The bazelisk targets to build.  Defaults to ":release".

      .. zuul:jobvar:: baselisk_test_targets

         The bazelisk targets to test.
    run: playbooks/gerrit/build.yaml
    timeout: 3600
    vars:
      bazelisk_targets: ":release"
      bazelisk_artifacts:
        - bazel-bin/release.war
      zuul_work_dir: "{{ ansible_user_dir }}/src/gerrit.googlesource.com/gerrit"
      test_tag_filters: "--test_tag_filters=-flaky,-elastic,-git-protocol-v2"
      bazelisk_test_targets: "--test_env=GERRIT_NOTEDB=ON {{test_tag_filters}} //..."

- job:
    name: gerrit-plugin-build
    parent: gerrit-base
    description: |
      Builds a Gerrit plugin in-tree

      Responds to these variables:

      .. zuul:jobvar:: gerrit_plugin

         The name of the plugin to build.  Defaults to the project
         under test, but can be specified explicitly to build
         cross-repo.

      .. zuul:jobvar:: baselisk_targets

         The bazelisk targets to build.  Defaults to the gerrit_plugin
         specified above.

      .. zuul:jobvar:: baselisk_test_targets

         The bazelisk targets to test.  Defaults to
         "plugins/{{gerrit_plugin }}/..."
    run: playbooks/gerrit-plugin/build.yaml
    vars:
      gerrit_plugin: "{{ zuul.project.short_name }}"
      bazelisk_targets: "plugins/{{ gerrit_plugin }}:{{ gerrit_plugin }}"
      bazelisk_test_targets: "plugins/{{ gerrit_plugin }}/..."
      bazelisk_artifacts:
        - "bazel-bin/plugins/{{ gerrit_plugin }}/{{ gerrit_plugin }}.jar"
      zuul_work_dir: "{{ ansible_user_dir }}/src/gerrit.googlesource.com/gerrit"
