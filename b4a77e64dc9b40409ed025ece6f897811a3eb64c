{
  "comments": [
    {
      "key": {
        "uuid": "a398f6d6_15350b2d",
        "filename": "roles/bazelisk-build/tasks/main.yaml",
        "patchSetId": 6
      },
      "lineNbr": 5,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2020-02-15T13:06:19Z",
      "side": 1,
      "message": "Why hard code this? Han-Wen may know better, but we should probably use Google\u0027s Remote Build Execution (RBE), as documented in Documentation/dav-bazel.txt. That would mean to call it something like:\n\n  bazel build --config\u003dremote --remote_instance_name\u003dprojects/{{gerrit_code_review_project_id}}/instances/default_instance\n\nwhere {{gerrit_code_review_project_id}} would be a secret and should be retrieved during execution from the system.",
      "range": {
        "startLine": 5,
        "startChar": 36,
        "endLine": 5,
        "endChar": 93
      },
      "revId": "b4a77e64dc9b40409ed025ece6f897811a3eb64c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "96587d1c_7cd90bfe",
        "filename": "roles/bazelisk-build/tasks/main.yaml",
        "patchSetId": 6
      },
      "lineNbr": 5,
      "author": {
        "id": 1087826
      },
      "writtenOn": "2020-02-17T18:56:32Z",
      "side": 1,
      "message": "This is what the current CI script I based this on does.  My priority was getting something that worked at parity.",
      "parentUuid": "a398f6d6_15350b2d",
      "range": {
        "startLine": 5,
        "startChar": 36,
        "endLine": 5,
        "endChar": 93
      },
      "revId": "b4a77e64dc9b40409ed025ece6f897811a3eb64c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "b99b5654_221964b7",
        "filename": "roles/bazelisk-build/tasks/main.yaml",
        "patchSetId": 6
      },
      "lineNbr": 5,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2020-02-17T19:05:39Z",
      "side": 1,
      "message": "The current CI is using Docker image with pre warmed Bazel action and repository caches. One step in building docker image for thd CI is building Gerrit and populating caches on stable branches and master. RBE is another alternative that offers remote cache usage and remote execution.",
      "parentUuid": "96587d1c_7cd90bfe",
      "range": {
        "startLine": 5,
        "startChar": 36,
        "endLine": 5,
        "endChar": 93
      },
      "revId": "b4a77e64dc9b40409ed025ece6f897811a3eb64c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e6b80651_665eef18",
        "filename": "roles/bazelisk-build/tasks/main.yaml",
        "patchSetId": 6
      },
      "lineNbr": 5,
      "author": {
        "id": 1087826
      },
      "writtenOn": "2020-02-17T21:57:01Z",
      "side": 1,
      "message": "Yes, sorry, I just meant that this is the script I was working from:\n\nhttps://gerrit.googlesource.com/gerrit-ci-scripts/+/refs/heads/master/jenkins/gerrit-bazel-build-plugin.sh#21\n\nSo that\u0027s the command I went with.  I agree that we should look into caching.  Zuul has a number of facilities for this -- we\u0027re currently benefiting from Zuul\u0027s merger cache to limit interactions with Gerrit -- Zuul makes one request to update the internal merger cache when starting jobs, and then pushes that state to all of the nodes used in the job.  We\u0027re currently not using any prepared images, but we could, and if we did, then Zuul would only need to push the deltas onto the workers.  But at the moment, it only takes about 35 seconds to push the gerrit repo and all of the core plugins onto the worker (and most of that is command overhead, not network io).  So we can probably leave that optimization for later.  We can also look into using RBE, but the combination of needing to use a secret and wanting to do so in a repo where anyone can propose changes makes that complex (but not impossible).\n\nWithin the context of a local build, do you think the \"standalone\" arguments are inappropriate, or are they okay?",
      "parentUuid": "b99b5654_221964b7",
      "range": {
        "startLine": 5,
        "startChar": 36,
        "endLine": 5,
        "endChar": 93
      },
      "revId": "b4a77e64dc9b40409ed025ece6f897811a3eb64c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "1a3210b4_164dc8c6",
        "filename": "roles/bazelisk-build/tasks/main.yaml",
        "patchSetId": 6
      },
      "lineNbr": 5,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2020-02-18T07:44:44Z",
      "side": 1,
      "message": "The issue is with Bazel caches and not really with execution strategy. I have concerns to always build on the CI without any caches. On my laptop, where I am regularly building different gerrit branches:\n\n  davido@wizball:~/.gerritcodereview/bazel-cache/downloaded-artifacts$ du -sh .\n  373M\n\nand\n\n  davido@wizball:~/.gerritcodereview/bazel-cache/repository$ du -sh .\n  937M\n\nWe certainly should try to avoid fetching so much dependencies on each and every CI build.\n\nUsing the RBE, sounds very promising to me, because we don\u0027t have to re-build Docker images, it just works and is really fast. It takes ca. 4 min. to build and run all tests on Gerrit@HEAD for me.\n\nMoreover, I just realized, that Han-Wen mentioned the GCP gerrit project name in README.md: [1] of gerrit-linter project, so that probably it is not a secret at all and can we could just put here in clear text, done?\n\nCan you try it, if RBE build would just work on Zuul CI build? Note, though, you would need this change for PG plugins to be built properly, that was merged yesterday: [2].\n\n[1] https://gerrit.googlesource.com/gerrit-linter/+/refs/heads/master/README.md#docker-on-gcp\n[2] https://gerrit-review.googlesource.com/c/gerrit/+/255293",
      "parentUuid": "e6b80651_665eef18",
      "range": {
        "startLine": 5,
        "startChar": 36,
        "endLine": 5,
        "endChar": 93
      },
      "revId": "b4a77e64dc9b40409ed025ece6f897811a3eb64c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "b92586e2_d1619626",
        "filename": "roles/bazelisk-build/tasks/main.yaml",
        "patchSetId": 6
      },
      "lineNbr": 5,
      "author": {
        "id": 1087826
      },
      "writtenOn": "2020-02-18T15:00:45Z",
      "side": 1,
      "message": "That sounds like a great thing to explore.  Our shared goal is to get tests running for Gerrit plugins.  My time is limited and I think it is best spent getting basic tests up and running (they are!), demonstrating how the system works, and facilitating other people contributing.  I\u0027m not very familiar with RBE, so perhaps you could make a followup patch that implements it?  The nice thing about Zuul is that anyone can propose a patch and we can all see it work.",
      "parentUuid": "1a3210b4_164dc8c6",
      "range": {
        "startLine": 5,
        "startChar": 36,
        "endLine": 5,
        "endChar": 93
      },
      "revId": "b4a77e64dc9b40409ed025ece6f897811a3eb64c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "40346c38_61b61f02",
        "filename": "roles/bazelisk-build/tasks/main.yaml",
        "patchSetId": 6
      },
      "lineNbr": 12,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2020-02-15T13:06:19Z",
      "side": 1,
      "message": "Same as above --config\u003dremote [...]",
      "range": {
        "startLine": 12,
        "startChar": 30,
        "endLine": 12,
        "endChar": 34
      },
      "revId": "b4a77e64dc9b40409ed025ece6f897811a3eb64c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "4b1325ad_215a5109",
        "filename": "zuul.d/jobs.yaml",
        "patchSetId": 6
      },
      "lineNbr": 5,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2020-02-15T13:06:19Z",
      "side": 1,
      "message": "Nit: Unrelated here and could be fixed in the change where it was introduced?",
      "range": {
        "startLine": 5,
        "startChar": 28,
        "endLine": 5,
        "endChar": 29
      },
      "revId": "b4a77e64dc9b40409ed025ece6f897811a3eb64c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "3d1bb52d_f8131562",
        "filename": "zuul.d/jobs.yaml",
        "patchSetId": 6
      },
      "lineNbr": 30,
      "author": {
        "id": 1011123
      },
      "writtenOn": "2020-02-15T05:17:58Z",
      "side": 1,
      "message": "Builds a Gerrit plugin in-tree",
      "range": {
        "startLine": 30,
        "startChar": 6,
        "endLine": 30,
        "endChar": 28
      },
      "revId": "b4a77e64dc9b40409ed025ece6f897811a3eb64c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "d3074e74_4b8d942a",
        "filename": "zuul.d/jobs.yaml",
        "patchSetId": 6
      },
      "lineNbr": 30,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2020-02-22T18:04:00Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "3d1bb52d_f8131562",
      "range": {
        "startLine": 30,
        "startChar": 6,
        "endLine": 30,
        "endChar": 28
      },
      "revId": "b4a77e64dc9b40409ed025ece6f897811a3eb64c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    }
  ]
}